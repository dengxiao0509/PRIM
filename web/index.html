<!DOCTYPE html>
<!--###############################################################################
## This page is used to control SDL server and visulize results returned
###############################################################################
-->

<html>
<head>
    <title>Control Interface</title>
    <script>AUTOBAHN_DEBUG = true;</script>
    <script src="http://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz"></script>

    <script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>

    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.15.1/vis.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.15.1/vis.min.css" rel="stylesheet"/>

    <script type="text/javascript" src="lib/jquery.leanModal.min.js"></script>

    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" />

    <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1/themes/flick/jquery-ui.css">

    <link rel="stylesheet" type="text/css" href="css/index.css"/>
    <link rel="stylesheet" type="text/css" href="css/popup.css"/>
    <link rel="stylesheet" type="text/css" href="css/object.css"/>
    <link rel="stylesheet" type="text/css" href="css/rule.css"/>
    <link rel="stylesheet" type="text/css" href="css/env.css"/>
    <link rel="stylesheet" type="text/css" href="css/login.css"/>

</head>

<body>
<div id="wrapper">
    <div id="header">
        <div id="header_title"><span class="bigtitle">Control Everything in Your Home</span><span id="title_msg" class="err_msg"></span></div>
        <div id="loginInfo">
            <span id="welcome_msg"></span>
            <i id="logout_btn" class="fa fa-sign-out" aria-hidden="true">Log out</i>
            <a id="modal_trigger" href="#modal"><i class="fa fa-sign-in" aria-hidden="true"> Login / Sign up</i></a>
        </div>
    </div>
    <div id="body" class="clearfix">
        <div id="leftMenu">
            <div class="menuDiv">
                <div class="menuTitle">
                    <span>Session</span>
                    <span id="sessionIcons">
                        <span class="seperator">|</span>
                        <i class="fa fa-folder-open" aria-hidden="true" id="openSession" title="Open Session"></i>
                        <i class="fa fa-floppy-o" aria-hidden="true" id="saveSession" title="Save Session"></i>
                        <i class="fa fa-file-o" aria-hidden="true" id="newSession" title="New Session"></i>
                    </span>
                </div>
                <div class="menuContent">
                    <div id="currentSession"></div>
                </div>
            </div>
            <div class="menuDiv" id="serverSDLMenu">
                <div class="menuTitle">SDL Server</div>
                <div class="menuContent">
                    <div id="connectSDLBtn">
                        <input type="button" class="btn_sdl" id="btn_connect" value="Connect" /><br/>
                    </div>
                </div>
            </div>
            <div class="menuDiv" id="objClassMenu">
                <div class="menuTitle"><span>Object Class</span>
                    <i id="addObjClassIcon" class="fa fa-plus-circle" aria-hidden="true" title="Add Object Class"></i>
                </div>
                <div class="menuContent">
                    <div id="existingObj"></div>
                </div>
            </div>
            <div class="menuDiv" id="ruleMenu">
                <div class="menuTitle"><span>Rules</span>
                    <i id="addRuleIcon" class="fa fa-plus-circle" aria-hidden="true" title="Add Rule"></i>
                </div>
                <div class="menuContent">
                  <div id="userFilter">
                      <span>User: </span>
                      <select id="userList">
                      </select>
                  </div>
                  <div id="existingRules"></div>
                </div>
            </div>
        </div>
        <div id="midDiv">
            <div id="topMenu">
                <div id="deleteSelectedIcon">
                    <img  src="image/delete.png" width="20px"/>
                    <span class="btn_lable">Delete Selected</span>
                </div>
            </div>
            <div id="graph"></div>
        </div>
        <div id="rightMenu">
            <div class="menuDiv">
                <div class="menuTitle">
                    <span>Environment</span>
                    <i id="addEnvIcon" class="fa fa-plus-circle" aria-hidden="true" title="Add Environment Value"></i>
                </div>
                <div class="menuIcons">
                    <i id="startSimulIcon" class="fa fa-play-circle-o" aria-hidden="true" title="Start Simulation"></i>
                    <div id="progressbar"></div>
                </div>
                <div class="menuContent">
                    <div id="envVars">
                    </div>
                </div>
            </div>
        </div>
        <div id="modal" class="popupContainer" style="display: none;">
            <header class="popupHeader">
                <span class="header_title" id="loginFormTitle">Login</span>
                <span class="modal_close"><i class="fa fa-times"></i></span>
            </header>
            <section class="popupBody">
                <div class="user_login">
                    <div id="login_msg" class="err_msg"></div>
                    <form>
                        <label>Username</label><input type="text" id="username"/><br/>
                        <label>Password</label><input type="password" id="pw"/><br/>
                        <div class="checkbox">
                            <input id="remember" type="checkbox"><label for="remember">Remember me</label>
                        </div>
                        <div class="action_btns">
                            <div class="one_half">
                                <a id='loginSubmit' class="btn btn_blue">Login</a>
                            </div>
                            <div class="one_half last">
                                <a class="btn" id="register_form" name="register_form">Sign up</a>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="user_register">
                    <div id="register_msg" class="err_msg"></div>
                    <form>
                        <label>Username</label><input id="newUsername" type="text"/><br/>
                        <label>Password</label><input id="newPw" type="password"><br/>
                        <label>Confirm Password</label><input id="newPwConfirm" type="password"><br/>

                        <div class="action_btns">
                            <div class="one_half">
                                <a id="back_btn" class="btn">Back</a>
                            </div>
                            <div class="one_half last">
                                <a id='register_btn' class="btn btn_blue">Register</a>
                            </div>
                        </div>
                    </form>
                </div>
            </section>
        </div>
    </div>
    <div id="footer" class="clearfix"></div>
    <div id="addObjClassPopup">
        <div class="header_obj">
            <span id="nodeFormTitle" class="header_title">Add an Object</span>
        </div>
        <p id="nodeFormMsg" class="err_msg"></p>
        <div class="table">
            <div>
                <div class="row">
                    <div class="celllabel">Type *</div>
                    <div class="cell">
                        <div id="NodeShapeBts">
                            <input type="radio" id="dot" name="nodeShapes" value="dot" checked/><label class="btn_radio_small"
                                for="dot">AE</label>
                            <!--<input type="radio" id="square" name="nodeShapes" value="square"/><label class="btn_radio"-->
                                <!--for="square">User</label>-->
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="celllabel">Name *</div>
                    <div class="cell"><input type="text" id="nodeName" name="nodeName" /></div>
                </div>
            </div>
            <div id="EMFields">
                <div class="row row_textarea">
                    <div class="celllabel">Description</div>
                    <div class="cell">
                        <textarea id='EMdes' rows="2" cols="19"></textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="celllabel">Environment
                        <i id="nodeClassAddEnvVarIcon" class="fa fa-plus-circle" aria-hidden="true" title="add an environment variable"></i>
                    </div>
                </div>
                <div id="envEditDiv">
                    <div id="envVarsDiv">
                        <select id='nodeEnvVars' multiple></select>
                    </div>
                    <div id="envVarsSelected" class="inlineDiv">
                    </div>
                </div>
                <div class="row newVarLabel">
                    <div class="celllabel">Variables
                        <i id="addVarIcon" class="fa fa-plus-circle" aria-hidden="true" title="add a variable"></i>
                    </div>
                </div>
                <div id="newVar"></div>
            </div>
        </div>
        <br/>
        <div class="btns_obj">
            <input type="button" id="deleteThis" class="btn_red btn_obj" value="Delete"/>
            <input type="button" class="btn_obj" value="Cancel" id="cancelbt"/>
            <input type="button" class="btn_blue btn_obj" value="Save" id="savebt"/>
        </div>
        <input type="hidden" id="nodeId"/>
    </div>
    <div id="newNodePopup">
        <div class="header_obj">
            <span id="NewNodeFormTitle" class="header_title">Add an Object</span>
        </div>
        <p id="newNodeFormMsg" class="err_msg"></p>
        <div class="row">
            <div class="celllabel">Object Name :</div>
            <div class="cell"><input type="text" name="newNodeName" id="newNodeName"/></div>
        </div>
        <div class="row">
            <div class="celllabel">Device State</div>
            <div class="cell">
                <input type="text" id="newNodeDS"/>
             </div>
        </div>
        <div class="btns_obj">
            <input type="button" class="btn_obj" value="Cancel" id="cancelNewNode"/>
            <input type="button" class="btn_blue btn_obj" value="Save" id="saveNewNode"/>
        </div>
        <input type="hidden" id="nodeClassId"/>
        <input type="hidden" id="thisNodeID"/>
    </div>
    <div id="editNodePopup">
        <div class="header_obj">
            <span id="editNodeFormTitle" class="header_title">Edit an Object</span>
        </div>
        <p id="editNodeFormMsg" class="err_msg"></p>
        <div class="row">
            <div class="celllabel">Object Name :</div>
            <div class="cell"><input type="text" name="editNodeName" id="editNodeName"/></div>
        </div>
        <div class="row">
            <div class="celllabel">Device State</div>
            <div class="cell">
                <input type="text" id="editNodeDS"/>
            </div>
        </div>
        <div class="row">
            <div class="celllabel">Description</div>
            <div class="cell">
                <textarea id='editNodeDes' rows="2" cols="19"></textarea>
            </div>
        </div>
        <div class="row">
            <div class="celllabel">Environment
                <i id="editNodeAddEnvVarIcon" class="fa fa-plus-circle" aria-hidden="true" title="add a variable"></i>
            </div>
        </div>
        <div id="editNodeEnvEditDiv">
            <div id="editNodeEnvVarsDiv">
                <select id='editNodeEnvVars' multiple></select>
            </div>
        </div>
        <div class="row newVarLabel">
            <div class="celllabel">Variables
                <i id="addVarIconEditNode" class="fa fa-plus-circle" aria-hidden="true" title="add a variable"></i>
            </div>
        </div>
        <div id="editNodeVars"></div>
        <div class="btns_obj">
            <input type="button" class="btn_obj" value="Cancel" id="cancelEditNode"/>
            <input type="button" class="btn_blue btn_obj" value="Save" id="saveEditNode"/>
        </div>
        <input type="hidden" id="editNodeID"/>
    </div>
    <div id="addRuleChooseSE">
        <div class="header_obj">
            <span id="ruleSEFormTitle" class="header_title">Choose Sensors and Effectors</span>
        </div>
        <p id="ruleSEFormMsg" class="err_msg"></p>
        <div class="left">
            <span>Sensors</span>
            <div>
                <select id="sensorList" multiple>

                </select>
            </div>
        </div>
        <div class="mid"></div>
        <div class="right">
            <span>Effectors</span>
            <div>
                <select id="effectorList" multiple>
                </select>
            </div>
        </div>
        <div class="btns_obj">
            <input type="button" id="cancelRuleSE" class="btn_red btn_obj" value="Cancel"/>
            <input type="button" class="btn_blue btn_obj" value="Done" id="doneRuleSE"/>
        </div>
    </div>
    <div id="addRulePopup">
        <div class="header_obj">
            <span id="ruleFormTitle" class="header_title">Add a rule</span>
        </div>
        <p id="ruleFormMsg" class="err_msg"></p>
        <div class="table">
            <div class="row">
                <div class="celllabel">Name *</div>
                <div class="cell">
                    <input type="text" id="ruleName"/>
                </div>
            </div>
            <div class="row">
                <div class="celllabel">Color *</div>
                <div class="cell">
                    <input type="color" id="ruleColor" value="#848484"/>
                </div>
            </div>
            <span class="blockTitle">Sensors</span>
            <div id="sensors"></div>
            <span class="blockTitle">Effectors</span>
            <div id="actors"></div>
            <div class="btns_obj">
                <input type="button" id="deleteThisRule" class="btn_red btn_obj" value="Delete"/>
                <input type="button" class="btn_obj" value="Cancel" id="ruleCancelbt"/>
                <input type="button" class="btn_blue btn_obj" value="Save" id="ruleSavebt"/>
            </div>
            <input type="hidden" id="ruleId"/>
        </div>
    </div>
    <div id="addEnvPopup">
        <div class="header_obj">
            <span id="envFormtitle" class="header_title">Add Environment Values</span>
        </div>
        <p id="envFormMsg" class="err_msg"></p>
        <div class="row newVarLabel">
            <div class="celllabel">Variables
                <i id="addEnvVarIcon" class="fa fa-plus-circle" aria-hidden="true" title="add a variable"></i>
            </div>
        </div>
        <div id="newEnvVar">

        </div>
        <div class="btns_obj">
            <input type="button" class="btn_obj" value="Cancel" id="cancelEnvbt"/>
            <input type="button" class="btn_blue btn_obj" value="Save" id="saveEnvbt"/>
        </div>
    </div>
    <div id="editEnvPopup">
        <div class="header_obj">
            <span class="header_title">Edit Environment Value</span>
        </div>
        <p id="envEditFormMsg" class="err_msg"></p>
        <div class="row">
            <div class="celllabel" id="vname"></div>
            <div class="cell"><input type="text" name="vvar" id="vvar"/></div>
        </div>
        <div class="row">
            <div class="celllabel">
                <input type="checkbox" id="isEvolute" /><label for="isEvolute">Evolution</label>
            </div>
        </div>
        <div id="evolutionDiv">
            <div class="row">
                <div class="celllabel">Range</div>
                <div>
                    <input type="number" id="rangeFrom"/><span class="line"> - </span> <input id="rangeTo" type="number"/>
                </div>
            </div>
            <div class="row">
                <div class="celllabel">Interval (s)</div>
                <div>
                    <input type="number" id="interval"/>
                </div>
            </div>
        </div>
        <div class="btns_obj">
            <input type="button" id="deleteThisEnv" class="btn_red btn_obj" value="Delete"/>
            <input type="button" class="btn_obj" value="Cancel" id="cancelEnvEditbt"/>
            <input type="button" class="btn_blue btn_obj" value="Save" id="saveEnvEditbt"/>
        </div>
        <input type="hidden" />
    </div>
    <div id="saveSessionPopup">
        <div class="header_obj">
            <span class="header_title">Save Current Session</span>
        </div>
        <p id="saveSessionFormMsg" class="err_msg"></p>
        <div class="row">
            <div class="celllabel">Name*: </div>
            <div class="cell"><input type="text" name="sessionName" id="sessionName"/></div>
        </div>
        <div class="btns_obj">
            <input type="button" class="btn_obj" value="Cancel" id="cancelSessionBtn"/>
            <input type="button" class="btn_blue btn_obj" value="Save" id="saveSessionBtn"/>
        </div>
        <input type="hidden" id="hid_open">
        <input type="hidden" id="hid_new">
    </div>
    <div id="openSessionPopup">
        <div class="header_obj">
            <span class="header_title">Open a Session</span>
        </div>
        <p id="openSessionFormMsg" class="err_msg"></p>
        <div>
            <select id="existingSessions"></select>
        </div>
        <div class="btns_obj">
            <input type="button" class="btn_obj" value="Cancel" id="cancelOpenSessionBtn"/>
            <input type="button" class="btn_blue btn_obj" value="Open" id="openSessionBtn"/>
        </div>
    </div>
</div>

<script>

    //login and register popup
    $("#modal_trigger").leanModal({top:200,overlay:0.3,closeButton: ".modal_close"});
    $("#modal").draggable();

    //predefine network and session
    var network = null;
    var localUsers = null;

    var leftMenuWidth = "200px";

    var session_global = null;
    var currentSession = "untitled";
    var isConnectSDL = false;
    var user = "";

    //destroy graph
    function destroy(){
        if(network !== null){
            network.destroy();
            network = null;
        }
    }

    //close all popups
    function closeAllPopup(){
        $("#addObjClassPopup").hide();
        $("#newNodePopup").hide();
        $("#editNodePopup").hide();
        $("#addRuleChooseSE").hide();
        $("#addRulePopup").hide();
        $("#addEnvPopup").hide();
        $("#editEnvPopup").hide();
        $("#saveSessionPopup").hide();
        $("#openSessionPopup").hide();
    }

    //press enter key to submit form
    function enterToSubmit(saveBtId){
        $(document).keypress(function(event){

            var keycode = (event.keyCode ? event.keyCode : event.which);
            if(keycode == '13'){
                $("#"+saveBtId).click();
            }
        });
    }

</script>

<!--/////////////////////////////////   Manage Session //////////////////////////////////////////////////////////////////-->
<script src="js/session.js"></script>

<!--/////////////////////////////////   Manage Environment //////////////////////////////////////////////////////////////////-->
<script src="js/environment.js"></script>

<!--/////////////////////////////////   Manage Objects(Nodes) ////////////////////////////////////////////////////////-->
<script src="js/object.js"></script>

<!--/////////////////////////////////   Manage Rules  /////////////////////////////////////////////////////////-->
<script src="js/rule.js"></script>

<!--////////////////////////////////////////////  SDL Server //////////////////-->
<script>

    //connect to SDL server
    function connectSDLServer(){

        //call remote function in server.js to connect to SDL server
        session_global.call('sdlSCI.data.connectSDL').then(
                function(res){
                    if(res == "ok"){
                        console.log("connect SDL server successfully");
                        isConnectSDL = true;
                        $("#connectSDLBtn").html(" SDL Server Connected ");
                        $("#currentSession").html(currentSession);
                    }
                    else {
                        console.log("connect SDL server :"+res);
                        var htmlContent = $("#connectSDLBtn").html();
                        htmlContent += "<span class='err_msg'>"+res+"</span>";
                        $("#connectSDLBtn").html(htmlContent);
                    }
                },session_global.log);

    }
    $("#btn_connect").click(connectSDLServer);  // this btn is hidden, when page loaded, try to connect to SDL server automatically


    /////////////////// graph /////////////////////////////////////////////////
    var container = document.getElementById('graph');

    //define options for Network (graph)
    /***********************************************************/
    var options = {
        physics:{
            stabilization: true,
            timestep: 0.3
        },
        manipulation: {
            enabled: false,
            addNode: false,
            addEdge: false,
            editEdge: false,
            deleteNode: function (data, callback) {
                if (confirm("Are you sure that you want to delete this node?")) {
                    callback(data);
                    //data is an array of selected Nodes and Edges
                    session.call('sdlSCI.data.changeData', ['node', 'remove', data]).then(
                            function (res) {
                                console.log(res);
                            }, session.log);
                }
                else {
                    callback(null);
                }
            },
            deleteEdge: false
        },
        interaction: {
            hover: true,
            multiselect: true,
            dragView: false,
            zoomView: false
        },
        nodes:{
            physics:false
        },
        edges: {
            arrows: {
                to: {enabled: true, scaleFactor: 0.5},
                middle: {enabled: false, scaleFactor: 1},
                from: {enabled: false, scaleFactor: 1}
            },
            physics: false
        }
    };
    /***********************************************************/

    //initialize graph and menus display according to data got from server.js
    function init(res){

        /* Store all data returned by server to a local variable called 'localData'
        /* including  nodes(object),edges,rules,nodeclass(object class),environment variables, sessions, sdl server status.
        /* we need node and edge information to draw graph later.
        */
        var nodesArray = Object.keys(res.nodes).map(key => res.nodes[key]);
        var edgesArray = Object.keys(res.edges).map(key => res.edges[key]);
        var usersArray = Object.keys(res.users);
        var nodeClassesArray = res.nodeClasses;
        var rulesArray = res.rules;
        var envArray = res.env;
        var sessionArray = res.sessions;

        var nodesDataSet = new vis.DataSet(nodesArray);
    //                    var edgesDataSet = new vis.DataSet(edgesArray);
        var edgesDataSet = new vis.DataSet({});
        var allEdgesDataSet = new vis.DataSet(edgesArray);
        var data = {
            nodes: nodesDataSet,
            edges: edgesDataSet,
            nodeClasses: nodeClassesArray,
            rules: rulesArray,
            users: usersArray,
            allEdges : allEdgesDataSet,
            env: envArray,
            currentSession: res.currentSession,
            isConnectSDL : res.isConnectSDL
        }

        localData = data;

        //session and connect sdl server status
        currentSession = res.currentSession;
        $("#currentSession").html(currentSession);
        isConnectSDL = localData.isConnectSDL;

        //if web server doesn't connect to SDL server, connect it
        if(isConnectSDL == false) {
            connectSDLServer();
        }
        else{
            //server already connected to SDL server
            $("#connectSDLBtn").html(" SDL Server Connected ");
        }

        //draw graph
        network = new vis.Network(container, localData, options);

        //drag node end event (change node position)
        network.on("dragEnd", function (params) {
            dragEndEventHandler(params);
        });

        //double click node event => edit node
        network.on("doubleClick", function (params) {
            var nodeId = params.nodes[0];
            //double click on nodes to edit their labels
            if (nodeId != undefined) {
                if (user == "admin") {
                    $("#editNodePopup").show();
                    enterToSubmit("saveEditNode");
                    $("#editNodeID").val(nodeId);

                    var node = localData.nodes.get(nodeId);

                    var label = node.label;
                    $("#editNodeName").val(label);
                    var ds = node.devicestate;
                    $("#editNodeDS").val(ds);
                    $("#editNodeDes").val(node.description);
                    var vars = node.variables;
                    var container = document.getElementById("editNodeVars");

                    while (container.firstChild) {
                        container.removeChild(container.firstChild);
                    }

                    updateEnvForNodeForm();
                    for(var vName in vars) {
                        if(vName == "env") {
                            for(var t in node.variables["env"]){
                                $("#editNodeEnvVars option[value='"+node.variables["env"][t]+"']").prop("selected",true);
                            }
                        }
                        else {
                            var nodeDiv = document.createElement("div");
                            nodeDiv.setAttribute("class", "row");

                            var nodeInput1 = document.createElement("input");
                            nodeInput1.setAttribute("placeholder", "Name");
                            nodeInput1.setAttribute("type", "text");
                            nodeInput1.setAttribute("value", vName);

                            var nodeInput2 = document.createElement("input");
                            nodeInput2.setAttribute("placeholder", "Value");
                            nodeInput2.setAttribute("type", "text");
                            nodeInput2.setAttribute("value", vars[vName]);

                            var nodeImg = document.createElement("img");
                            nodeImg.setAttribute("class", "deleteVarIcon");
                            nodeImg.setAttribute("onclick", "deleteNewVar(this)");
                            nodeImg.setAttribute("src", 'image/delete.png');
                            nodeImg.setAttribute("width", '16px');
                            nodeImg.setAttribute("title", 'delete this variable');

                            nodeDiv.appendChild(nodeInput1);
                            nodeDiv.appendChild(nodeInput2);
                            nodeDiv.appendChild(nodeImg);

                            container.appendChild(nodeDiv);
                        }
                    }
                }
                else {
                    alert("Only administrator can edit nodes ...");
                }
            }
        });

        //clear edges shown when click anywhere in the graph
        network.on("click",function(params){
            localData.edges.clear();
        });

        //if loged user is admin, add the possibility of deleting nodes
        //if not, hide user list in the left menu
        if(user == "admin"){
            //select nodes event handler => delete nodes
            network.on("selectNode", function (params) {
                //show delete selected button

                $("#deleteSelectedIcon").css("display", "inline-block");

                var nodes = params.nodes;
                var edges = params.edges;
                var args = {};
                args.nodes = nodes;
                args.edges = edges;
                args.rules = [];

                //delete node event handler
                document.getElementById("deleteSelectedIcon").onclick = function () {

                    if (confirm("Are you sure that you want to delete selected nodes?")) {

                        for (var n in nodes) {

                            //delete referring edges and rules
                            var group_del = localData.allEdges.get({
                                filter: function (item) {
                                    console.log(item.from + ";;" + item.to);
                                    return (item.from == nodes[n] || item.to == nodes[n]);
                                }
                            });

                            var edges_del = [];  //ids of edges connecting this node

                            for (var j in group_del) {
                                edges_del.push(group_del[j].id);
                            }

                            for (var i in localData.rules) {
                                var ruleItem = localData.rules[i];
                                for (var j in edges_del) {
                                    if (ruleItem.edges.indexOf(edges_del[j]) !== -1) {
                                        //delete this rule
                                        if (args.rules.indexOf(i) == "-1") {
                                            args.rules.push(i);
                                        }
                                        break;
                                    }
                                }
                            }
                        }

                        //data is an array of selected Nodes and Edges
                        session_global.call('sdlSCI.data.changeData', ['node', 'remove', args]).then(
                                function (res) {
                                    $("#deleteSelectedIcon").hide();
                                }, session_global.log);
                    }
                }

            });
            //hide top menu when deselect nodes in the graph
            network.on("deselectNode",function(params){
                $("#deleteSelectedIcon").hide();
            });
        }
        else{
            //hide user filter and only show logging user's rules
            $("#userList option[value='"+user+"']").prop("selected",true);
            $("#userList").change();
            $("#userFilter").hide();
        }

        //update user list in the left menu 'Rules' block
        updateExistingUsers();

        //update object class
        updateExistingObjClass();

        //update rules
        updateExistingRules();

        //update environment variables in the right menu
        updateEnv();
}


    //authentication
    function onchallenge(session, method, extra) {
        if (method === 'wampcra') {
            return autobahn.auth_cra.sign(key, extra.challenge);
        } else {
            throw "don't know how to authenticate using '" + method + "'";
        }
    }

    // the URL of the WAMP Router (Crossbar.io)
    var wsuri;
    if (document.location.origin == "file://") {
        wsuri = "ws://127.0.0.1:8080/ws";

    } else {
        wsuri = (document.location.protocol === "http:" ? "ws:" : "wss:") + "//" +
                document.location.host + "/ws";
    }

    //////////////////////////      Register and Login   ////////////////////////////////////////

    //open register form
    $("#register_form").click(function(){
        $(".user_register").show();
        $(".user_login").hide();
        $("#loginFormTitle").text('Register');
    });

    //open login form
    $("#back_btn").click(function(){
        $(".user_login").show();
        $(".user_register").hide();
        $("#loginFormTitle").text('Login');

        //clear register form
        $("#newUsername").val("");
        $("#newPw").val("");
        $("#newPwConfirm").val("");
    });

    //close login/register popup
    function close_modal_login(){
        $("#modal").hide();
        $("#lean_overlay").hide();

        $(".user_login").show();
        $(".user_register").hide();

        $("#loginFormTitle").html("Login");
    }



    //  ------  Register form submit ------
    // When user registering, open a connection and try to register him in the server side
    // including password and username validity check
    $("#register_btn").click(function(){
        $("#register_msg").html("");

        var newUsername = $("#newUsername").val();
        var newPw = $("#newPw").val();

        if($("#newPwConfirm").val() == newPw){

            // the WAMP connection to the Router
            //
            user = "registerUser";
            key = 'registerUser';

            var connection = new autobahn.Connection({
                url: wsuri,
                realm: "realm1",
                authmethods: ["wampcra"],
                authid: user,
                onchallenge: onchallenge
            });

            connection.onopen = function (session, details) {

                //handle eventuel errors according to respose of authenticator.js
                session.call('sdl.auth.registerUser', [newUsername, newPw]).then(
                        function (res) {
                            console.log(res);
                            if (res === "ok") {
                                // clear all fields
                                $("#newUsername").val('');
                                $("#newPw").val('');
                                $("#newPwConfirm").val('');

                                $(".user_login").show();
                                $(".user_register").hide();

                                $("#loginFormTitle").html("Login");
                                $("#login_msg").html("Sign up finished successfully, now you can log in and enjoy !");

                                connection.close('Register procedure finished with success.');
                            }
                            else if(res == "duplicate_username"){
                                $("#register_msg").html("Opps, this username is already taken...");
                                connection.close('Register procedure not finished.');
                            }
                            else if(res == "short_pw"){
                                $("#register_msg").html("Your password must have at least 6 characters... ");
                                connection.close('Register procedure not finished.');
                            }
                            else {
                                $("#register_msg").html("error!");
                                connection.close('Register procedure ended with error.');
                            }
                        }, session.log
                );
            }

            connection.onclose = function (reason, details) {
                onclose(reason, details);
            }

            connection.open();
        }
        else{
            $("#register_msg").html("* Two passwords entered are different,please try again ...");
        }
    });

    //  ------  Login form submit ------
    // When user loging in, check his authentication then open a session, initialize graph  and interface
    // if remember me is checked, store his login info in web Storage
    // logout event handler is also defined here
    $("#loginSubmit").click(function () {

        $("#login_msg").html("");

        user = $("#username").val();
        key = $("#pw").val();

        // the WAMP connection to the Router
        //
        var connection = new autobahn.Connection({
            url: wsuri,
            realm: "realm1",
            authmethods: ["wampcra"],
            authid: user,
            onchallenge: onchallenge

        });

        connection.onclose = function (reason, details) {
//            console.log(details);
            if(details.reason === "wamp.error.authentication_failed") {
                $("#login_msg").html("* Wrong username or password!");
            }
            onclose(reason, details);
        }

        connection.onopen = function (session, details) {

            session_global = session;

            main(session, details,user);

            //close login popup
            close_modal_login();

            $("#title_msg").html("");

            //change Login/Register Button to Welcome Username
            $("#welcome_msg").html("<i class=\"fa fa-user\" aria-hidden=\"true\"></i>Welcome "+user);
            $("#welcome_msg").show();
            $("#modal_trigger").hide();
            $("#logout_btn").show();


            if (typeof (Storage) !== "undefined") {
                localStorage.username = user;
                localStorage.pw = key;

                if($("#remember").prop('checked')) {
                    localStorage.remember = "true";
                }
                else {
                    localStorage.remember = "false";
                }
                localStorage.isLogin = "true";

                //define log out event handler
                document.getElementById("logout_btn").onclick = function(){
//                    console.log('logout');

                    $("#welcome_msg").html('');
                    $("#welcome_msg").hide();
                    $("#modal_trigger").show();
                    $("#logout_btn").hide();

                    $("#midDiv").hide();
                    $("#rightMenu").hide();
                    $("#leftMenu").hide();

                    //remember me not checked
                    if(localStorage.remember == "false") {
                        localStorage.removeItem('username');
                        localStorage.removeItem('pw');
                        localStorage.removeItem('remember');
                        localStorage.removeItem('isLogin');
                    }
                    else {
                        localStorage.isLogin = "false";
                    }
                    connection.close('User Loged out.');
                    destroy();
                }
            }
            else {
                console.log('sorry, no web localstorage support...');
            }
        }

        // now actually open the connection
        //
        connection.open();
    });


    if (typeof (Storage) !== "undefined") {

        //open login popup event, fill the fileds username and password if stored in web storage
        $("#modal_trigger").click(function(){

            if(localStorage.username) {
                $("#username").val(localStorage.username);
                $("#pw").val(localStorage.pw);
                $("#remember").prop("checked",true);
            }
            else {
                $("#username").val("");
                $("#pw").val("");
                $("#remember").prop("checked",false);
            }

            $(".user_login").show();
            $(".user_register").hide();

            $("#loginFormTitle").html("Login");
            $("#register_msg").html("");
            $("#login_msg").html("");
        });

        // check whether there exists username and password in web storage
        // if yes, log in automatically and open a connection then initialize interface
        if (localStorage.username && localStorage.isLogin == "true") {

            user = localStorage.username;
            key = localStorage.pw;

            // the WAMP connection to the Router
            var connection = new autobahn.Connection({
                url: wsuri,
                realm: "realm1",
                authmethods: ["wampcra"],
                authid: user,
                onchallenge: onchallenge
            });

            connection.onopen = function (session, details) {

                //change Login/Register Button to Welcome Username
                $("#welcome_msg").html("<i class=\"fa fa-user\" aria-hidden=\"true\"></i>Welcome "+user);
                $("#welcome_msg").show();
                $("#modal_trigger").hide();
                $("#logout_btn").show();

                $("#midDiv").show();

                session_global = session;

                main(session, details,user);
                $("#title_msg").html("");
            }
            connection.onclose = function (reason, details) {
                //if authentication fails
                if(details.reason === "wamp.error.authentication_failed") {

                    //when localStorage is not empty and user.txt doesn't contain this user
                    //for exemple, user.txt is removed  then restart the computer
                    if($("#modal").css("display") == "none") {

                        $("#welcome_msg").html('');
                        $("#welcome_msg").hide();
                        $("#modal_trigger").show();
                        $("#logout_btn").hide();

                        $("#midDiv").hide();
                        $("#leftMenu").hide();
                        $("#rightMenu").hide();

                        destroy();

                        $("#modal_trigger").click();
                        localStorage.removeItem('username');
                        localStorage.removeItem('pw');
                        localStorage.removeItem('remember');
                        localStorage.removeItem('isLogin');

                    }
                    $("#login_msg").html("Wrong username or password!");
                }

                onclose(reason, details);
            }

            //define log out event handler
            document.getElementById("logout_btn").onclick = function(){

                console.log('logout');

                $("#welcome_msg").html('');
                $("#welcome_msg").hide();
                $("#modal_trigger").show();
                $("#logout_btn").hide();

                $("#midDiv").hide();
                $("#leftMenu").hide();
                $("#rightMenu").hide();

                if(localStorage.remember == "false") {
                    localStorage.removeItem('username');
                    localStorage.removeItem('pw');
                    localStorage.removeItem('remember');
                    localStorage.removeItem('isLogin');
                }
                else {
                    localStorage.isLogin = "false";
                }

                connection.close('User Loged out.');
                destroy();
            }

            // now actually open the connection
            connection.open();

        }

        //if no, no login saved
        else {
            console.log("no login");
            $("#title_msg").html("  (No connection)");
            $("#welcome_msg").html('');
            $("#welcome_msg").hide();
            $("#modal_trigger").show();
            $("#logout_btn").hide();

            $("#leftMenu").hide();
            $("#midDiv").hide();
            $("#rightMenu").hide();
//            alert("please log in first...");
        }
    }
    else {
        console.log('Sorry, no web storage support.');
        console.log("no login");
        $("#title_msg").html("  (No connection)");
        $("#welcome_msg").html('');
        $("#welcome_msg").hide();
        $("#modal_trigger").show();

        $("#logout_btn").hide();
        $("#midDiv").hide();
        $("#rightMenu").hide();
        $("#leftMenu").hide();
    }


    // fired when connection is established and session attached
    // including set page display(menus displayed or not) and initialize
    function main(session, details,user) {

        // ------ SET page display according to logging user (admin or not) ----------

        //show admin menus for admin user, if not, hide it
        $("#leftMenu").show();
        $("#midDiv").css("margin-left",leftMenuWidth);

            //menus shown for administrator
            if(user === "admin") {
                $("#midDiv").show();
                $("#objClassMenu").show();
                $("#serverSDLMenu").show();
                $("#rightMenu").show();
                $("#midDiv").css("margin-right",'120px');
                $("#sessionIcons").show();

            }
            else {
                $("#objClassMenu").hide();
                $("#serverSDLMenu").hide();
                $("#midDiv").show();
                $("#midDiv").css("margin-right",'0');
                $("#sessionIcons").hide();
            }

        //set menu bars height for adapting to the screen size
        var barHeight = $("#midDiv").css("height");
        $("#leftMenu").css("height",barHeight);
        $("#rightMenu").css("height",barHeight);


        // ------- subscribe to future change data event --------

        //node data changed
        session.subscribe("sdlSCI.data.onChangeObj",onChangeObj);

        // nodes' positions changed
        session.subscribe("sdlSCI.data.onUpdatePos", onUpdatePos);

        // node class data changed
        session.subscribe("sdlSCI.data.onchangeNodeClass",onchangeNodeClass);

        // rule data changed
        session.subscribe("sdlSCI.data.onChangeRule",onChangeRule);

        // environment data changed
        session.subscribe("sdlSCI.data.onChangeEnv", onChangeEnv);

        // session changed (when opening or create a new session)
        session.subscribe("sdlSCI.session.onChangeSession",onChangeSession);

        // session name changed (when clicking 'save session')
        session.subscribe("sdlSCI.session.onChangeSessionName",onChangeSessionName);

        // -------- Initialize -------
        // CALL a remote procedure: get initial data
        session_global.call('sdlSCI.data.getData').then(
                function (res) {
                    init(res);  //initialize interface
                },
                // if get data error
                function (err) {
                    console.log("getData() error:", err);
                }
        );

        //get saved sessions
        session_global.call('sdlSCI.data.getSessions').then(
                function(res){
                    sessions = res;
                },session_global.log
        )

    }


    // fired when connection was lost (or could not be established)
    function onclose(reason, details) {
        console.log("Connection lost: " + reason);

        //TODO
        //disable all operations
        if(localStorage.isLogin == 'true') {
            $("#logout_btn").click();
        }
        $("#title_msg").html("  (No connection)");
    }


</script>
</body>
</html>
